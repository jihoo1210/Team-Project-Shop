name: Deploy Frontend and Backend

on:
  push:
    branches: [ main ]

env:
  # 백엔드 환경 변수
  DB_URL: ${{ secrets.DB_URL }}
  DB_USERNAME: ${{ secrets.DB_USERNAME }}
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
  JWT_SECRET: ${{ secrets.JWT_SECRET }}
  GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
  GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
  NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
  NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  TOSS_SECRET_KEY: ${{ secrets.TOSS_SECRET_KEY }}
  UPLOAD_DIR: ${{ secrets.UPLOAD_DIR }}
  FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
  # 프론트엔드 환경 변수
  VITE_TOSS_CLIENT_KEY: ${{ secrets.VITE_TOSS_CLIENT_KEY }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # --- Node.js 설정 ---
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # --- Java 설정 ---
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      # --- React 빌드 (환경 변수 주입) ---
      - name: Build React Frontend
        run: |
          cd frontend
          cat > .env.production << EOF
          VITE_API_BASE_URL=/api
          VITE_TOSS_CLIENT_KEY=${{ secrets.VITE_TOSS_CLIENT_KEY }}
          EOF
          npm install
          npm run build

      # --- Spring Boot 빌드 ---
      - name: Build Spring Boot Backend
        run: |
          cd backend
          chmod +x ./gradlew
          ./gradlew build -x test

      # --- 서버에 배포 폴더 생성 ---
      - name: Create Deploy Directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            mkdir -p /home/project/www
            mkdir -p /home/project/webapps
            rm -rf /home/project/www/* 2>/dev/null || true

      # --- 서버로 파일 전송 (SCP) ---
      - name: Transfer Files to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          source: "frontend/dist/*,backend/build/libs/*.jar"
          target: "~/deploy"
          strip_components: 0
          overwrite: true

      # --- 서버에서 배포 스크립트 실행 (환경 변수 주입) ---
      - name: Execute Deployment Script
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          envs: DB_URL,DB_USERNAME,DB_PASSWORD,JWT_SECRET,GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET,NAVER_CLIENT_ID,NAVER_CLIENT_SECRET,OPENAI_API_KEY,TOSS_SECRET_KEY,UPLOAD_DIR,FRONTEND_URL
          script: |
            DEPLOY_DIR=~/deploy

            # React: 배포 경로로 복사
            rm -rf /home/project/www/*
            cp -r $DEPLOY_DIR/frontend/dist/* /home/project/www/

            # Spring Boot: 기존 프로세스 종료
            fuser -k 8083/tcp || true

            # JAR 파일을 지정된 경로로 복사
            JAR_FILE=$(ls $DEPLOY_DIR/backend/build/libs/*.jar | grep -v plain | head -1)
            cp "$JAR_FILE" /home/project/webapps/backend.jar

            # 환경 변수 파일 생성
            cat > /home/project/webapps/app.env << EOF
            export DB_URL="${DB_URL}"
            export DB_USERNAME="${DB_USERNAME}"
            export DB_PASSWORD="${DB_PASSWORD}"
            export JWT_SECRET="${JWT_SECRET}"
            export GOOGLE_CLIENT_ID="${GOOGLE_CLIENT_ID}"
            export GOOGLE_CLIENT_SECRET="${GOOGLE_CLIENT_SECRET}"
            export NAVER_CLIENT_ID="${NAVER_CLIENT_ID}"
            export NAVER_CLIENT_SECRET="${NAVER_CLIENT_SECRET}"
            export OPENAI_API_KEY="${OPENAI_API_KEY}"
            export TOSS_SECRET_KEY="${TOSS_SECRET_KEY}"
            export UPLOAD_DIR="${UPLOAD_DIR:-./uploads/product}"
            export FRONTEND_URL="${FRONTEND_URL:-https://pr.musecom.net}"
            export SERVER_PORT=8083
            EOF
            chmod 600 /home/project/webapps/app.env

            # 환경 변수 로드 후 실행
            source /home/project/webapps/app.env

            nohup java -jar \
              -Dspring.profiles.active=prod \
              -Dapp.frontend-url="${FRONTEND_URL:-https://pr.musecom.net}" \
              /home/project/webapps/backend.jar > /home/project/webapps/app.log 2>&1 &

            # 서버 시작 확인
            sleep 15
            curl -f http://localhost:8083/actuator/health || echo "Health check pending..."

            echo "Deployment completed successfully!"
